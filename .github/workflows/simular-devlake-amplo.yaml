name: Simular Dados Amplos DevLake

on:
  workflow_dispatch:
    inputs:
      quantidade:
        description: "Quantas simula√ß√µes deseja executar?"
        required: true
        default: "5"

jobs:
  simular-avancado:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout reposit√≥rio
        uses: actions/checkout@v4

      - name: Simular m√∫ltiplas execu√ß√µes avan√ßadas
        run: |
          AUTHORS=("Alice Dev" "Bob Ops" "Carol QA" "Dan UX")
          LABELS=("enhancement" "refactor" "hotfix" "docs")

          for i in $(seq 1 ${{ github.event.inputs.quantidade }}); do
            echo "üîÅ Simula√ß√£o $i"

            # Autor simulado
            AUTHOR=${AUTHORS[$((RANDOM % ${#AUTHORS[@]}))]}
            AUTHOR_EMAIL=$(echo "$AUTHOR" | tr '[:upper:]' '[:lower:]' | tr ' ' '.')@example.com

            git config user.name "$AUTHOR"
            git config user.email "$AUTHOR_EMAIL"

            BRANCH="feature/amplo-dora-${i}-$(date +%s)"
            git checkout -b "$BRANCH"

            FILE="src/simulacao_${i}.py"
            mkdir -p src
            echo "# Arquivo gerado por $AUTHOR" > "$FILE"
            echo "print('Simula√ß√£o DORA Avan√ßada $i - $(date)')" >> "$FILE"

            # Simula m√∫ltiplos commits por PR
            git add "$FILE"
            git commit -m "feat: in√≠cio da simula√ß√£o $i"

            echo "# Segunda altera√ß√£o" >> "$FILE"
            git add "$FILE"
            git commit -m "chore: ajuste menor na simula√ß√£o $i"

            echo "# Terceira modifica√ß√£o" >> "$FILE"
            git add "$FILE"
            git commit -m "refactor: mudan√ßa de estrutura na simula√ß√£o $i"

            git push origin "$BRANCH"

            # Criar Pull Request com label variada
            PR_LABEL=${LABELS[$((RANDOM % ${#LABELS[@]}))]}
            PR_DATA=$(jq -n \
              --arg title "Simula√ß√£o Avan√ßada $i por $AUTHOR" \
              --arg head "$BRANCH" \
              --arg base "main" \
              --arg body "Esta PR simula atividade realista para o DevLake." \
              '{title: $title, head: $head, base: $base, body: $body}')

            RESPONSE=$(curl -s -X POST -H "Authorization: token ${{ secrets.GH_PAT }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/pulls \
              -d "$PR_DATA")

            PR_NUMBER=$(echo "$RESPONSE" | jq -r .number)

            if [ "$PR_NUMBER" = "null" ] || [ -z "$PR_NUMBER" ]; then
              echo "‚ùå PR falhou na cria√ß√£o. Pulando simula√ß√£o."
              continue
            fi

            # Adicionar label √† PR
            curl -s -X POST -H "Authorization: token ${{ secrets.GH_PAT }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/$PR_NUMBER/labels \
              -d "{\"labels\": [\"$PR_LABEL\"]}"

            # Varia tempo de "review"
            SLEEP_TIME=$((RANDOM % 30 + 10))
            echo "‚è≥ Aguardando $SLEEP_TIME segundos para simular tempo de review..."
            sleep $SLEEP_TIME

            # Merge PR
            curl -s -X PUT -H "Authorization: token ${{ secrets.GH_PAT }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/merge \
              -d '{"merge_method": "merge"}'

            echo "‚úÖ PR #$PR_NUMBER mergeado"

            # 60% de chance de gerar bug
            if [ $((RANDOM % 10)) -lt 6 ]; then
              echo "üêû Simulando bug para essa execu√ß√£o"

              ISSUE_DATA=$(jq -n \
                --arg title "Bug simulado ap√≥s PR $PR_NUMBER" \
                --arg body "Este bug simula falha de produ√ß√£o para Change Failure Rate e MTTR." \
                '{title: $title, body: $body, labels: ["bug"]}')

              ISSUE_RESPONSE=$(curl -s -X POST -H "Authorization: token ${{ secrets.GH_PAT }}" \
                -H "Accept: application/vnd.github.v3+json" \
                https://api.github.com/repos/${{ github.repository }}/issues \
                -d "$ISSUE_DATA")

              ISSUE_NUMBER=$(echo "$ISSUE_RESPONSE" | jq -r .number)

              # Tempo de resolu√ß√£o vari√°vel
              MTTR_DELAY=$((RANDOM % 60 + 10))
              sleep $MTTR_DELAY

              curl -s -X PATCH -H "Authorization: token ${{ secrets.GH_PAT }}" \
                -H "Accept: application/vnd.github.v3+json" \
                https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER \
                -d '{"state": "closed"}'

              echo "‚úÖ Issue #$ISSUE_NUMBER fechada ap√≥s $MTTR_DELAY segundos"
            else
              echo "üëç Sem bug nesta simula√ß√£o"
            fi

            echo "-------------------------------------------"
          done
